<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers" data-namespace-typo3-fluid="true">

    <f:layout name="Default" />

    <f:section name="main">

        <div class="flex-container">
            <f:render partial="FlashMessages" arguments="{_all}" />
            <f:render partial="FormErrors" arguments="{object:Order}" />

            <f:if condition="{products}">

                <!-- form -->
                <f:form action="create" name="order" object="{order}" id="tx-rkw-order-form">
                    <f:render partial="Order/Form" arguments="{_all}" />

                    <!-- temporary fix because of special ajax-solution here -->
                    <script>
                        $("#tx-rkw-order-form").on('submit', function(e) {
                            $(this).find("button:not(.ajax)").prop('disabled',true).addClass('is-disabled');
                        });

                        $("#tx-rkw-order-form .js-open-mdl").modal();

                        $('.js-outcome')
                            .on('click', function (e) {
                                e.preventDefault();
                                if (confirm('Möchten Sie an unserer Zufriedenheitsumfrage teilnehmen?')) {

                                    /* @todo: Wird der eTracker hier ohnehin ausgelöst? */
                                    function triggerDownload (target) {
                                        const link = document.createElement('a');
                                        link.href = target.href;
                                        link.download = '';
                                        link.style.display = 'none';
                                        document.body.appendChild(link);
                                        link.click();
                                        document.body.removeChild(link);
                                    }

                                    triggerDownload(e.target);

                                    const orderForm = $('#tx-rkw-shop');
                                    const offset = orderForm.offset().top;
                                    orderForm.show();
                                    $("html, body")
                                        .animate({
                                                     'scrollTop': offset - 100
                                                 },
                                                 1000,
                                                 'easeOutQuart',
                                                 function () {
                                                     const firstModal = $('.js-open-mdl').first();
                                                     const targetInputId = firstModal.attr('for');

                                                     firstModal.trigger('click')
                                                         .parent()
                                                         .find(`input[id="${targetInputId}"]`)
                                                         .prop('checked', true);
                                                 }
                                        );

                                } else {
                                    /*
                                        @todo: Wie triggere ich den eTracker-Link erneut? Oder wird das Event bereits ohnehin ausgelöst?
                                     */
                                    window.open(e.target.href, '_blank');
                                }
                            });
                    </script>
                </f:form>

            </f:if>
        </div>
    </f:section>
</html>
